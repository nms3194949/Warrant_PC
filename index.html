<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOMO權證篩選器</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/cpexcel.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root{
    --deep:#0A1221;--card:#0C152A;
    --gold-grad:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%);
    --gold-solid:#E5C45A;--line:#223356;--muted:#9fb0d0;
  }
  html,body{margin:0;background:var(--deep);color:#fff;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{flex:1 1 220px;background:#0b1630;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:#fff;font-size:16px}
  label.chk{display:flex;align-items:center;gap:8px;background:#0b1630;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .btn-link{background:var(--gold-grad);color:#000;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;text-decoration:none;transition:.2s;white-space:nowrap}
  .btn-link:hover{background:linear-gradient(90deg,#FFEFA5 0%,#F4D97A 50%,#E0B94A 100%)}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;white-space:nowrap}
  th{position:sticky;top:0;background:#0f1b34;z-index:1}
  tbody tr:hover{background:#0f1b34}
  .tag{display:inline-block;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
  .hint{font-size:12px;color:var(--muted)}
  .gold-text{background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
  .exporting .gold-text{background:none !important;-webkit-text-fill-color:var(--gold-solid) !important;color:var(--gold-solid) !important}
  @media (max-width:540px){.field{flex:1 1 160px}.btn-link{padding:10px 14px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h3 style="margin:0">權證本地篩選（精簡）</h3>
    <p id="meta" class="hint">上傳 CSV / XLSX；預設：認購、排序 S1 升冪、排除價差比=0、距到期&gt;60 天。</p>

    <div class="row">
      <input id="fileInput" type="file" class="field" accept=".csv,.xlsx,.xls"/>
      <select id="selType" class="field" style="max-width:160px">
        <option value="C" selected>認購 (C)</option><option value="P">認售 (P)</option>
      </select>
      <select id="selSortKey" class="field" style="max-width:260px">
        <option value="spread">價差比</option><option value="leverage">槓桿</option>
        <option value="s1" selected>S1 = 價差比/槓桿</option><option value="s2">S2 = 價差比/槓桿/行使比例</option>
        <option value="days_left">距到期天數</option><option value="iv">成交價隱波</option>
      </select>
      <select id="selOrder" class="field" style="max-width:140px">
        <option value="asc" selected>升冪</option><option value="desc">降冪</option>
      </select>
      <select id="selLimit" class="field" style="max-width:140px">
        <option value="5">顯示 5 列</option><option value="10" selected>顯示 10 列</option>
        <option value="15">顯示 15 列</option><option value="20">顯示 20 列</option>
      </select>
      <label class="chk"><input type="checkbox" id="chkFilterZeroSpread" checked/>排除價差比=0</label>
      <a href="https://www.warrantwin.com.tw/eyuanta/Warrant/Search.aspx" target="_blank" class="btn-link">前往元大權證搜尋</a>
      <button id="btnExportPng" class="btn-link">匯出 PNG</button>
    </div>
  </div>

  <div id="resultCard" class="card" style="margin-top:12px;display:none">
    <div class="hint" id="meta2"></div>
    <div id="resultScroll" style="overflow:auto;max-height:70vh;margin-top:6px">
      <table id="resultTable">
        <thead>
          <tr>
            <th>代號</th><th>名稱</th><th>認購/售</th><th>價差比</th><th>槓桿</th><th>行使比例</th>
            <th>S1 = 價差比/槓桿</th><th>S2 = 價差比/槓桿/行使比例</th><th>距到期天數</th>
            <th>履約價</th><th>權證成交價</th><th>成交價隱波</th><th>價內外程度</th><th>流通在外比率</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const fmtNum=(v,d=2)=>(v==null||!isFinite(v))?"—":(+v).toFixed(d);
const showPct100=(v,d=2)=>(v==null||!isFinite(v))?"—":(v*100).toFixed(d)+"%";
function toHalfWidth(s){return String(s).replace(/[\uFF01-\uFF5E]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\u3000/g,' ');}
function num(x){if(x==null)return null;let s=String(x).trim();if(!s)return null;s=toHalfWidth(s).replace(/,/g,"").replace(/%$/,"");if(/^\.\d+$/.test(s))s="0"+s;const v=parseFloat(s);return isNaN(v)?null:v;}
function normalizeKey(k){if(k==null)return"";let s=String(k).replace(/\uFEFF/g,"");s=toHalfWidth(s).trim().replace(/\s+/g,"").replace(/\([^)]*\)/g,"").replace(/%/g,"");if(s.startsWith("Unnamed")||s==="__EMPTY")return"";return s.toLowerCase();}
const ALIAS={"權證代碼":["權證代碼","代碼"],"權證名稱":["權證名稱","名稱"],"買賣價差比":["買賣價差比","價差比"],"實質槓桿":["實質槓桿","槓桿"],"行使比例":["行使比例","轉換比率"],"距到期天數":["距到期天數","剩餘天數"],"履約價":["履約價"],"權證成交價":["權證成交價","成交價"],"成交價隱波":["成交價隱波","隱含波動率"],"價內外程度":["價內外程度"],"流通在外比率":["流通在外比率"]};
const N2STD=(()=>{const m=new Map();for(const s in ALIAS){ALIAS[s].forEach(a=>m.set(normalizeKey(a),s));}return m;})();
function normRow(row){const o={};for(const k in row){const nk=normalizeKey(k);if(!nk)continue;o[N2STD.get(nk)||k]=row[k];}return o;}
function mojibake(keys){if(!keys||!keys.length)return true;const s=keys.join("|");return / /.test(s)||(!/[\u4E00-\u9FFF]/.test(s)&&/[\u00C0-\u024F]/.test(s));}

let RAW=[];
$("#fileInput").addEventListener("change",()=>{
  const f=$("#fileInput").files[0]; if(!f) return;
  const done=(arr,label)=>{RAW=arr.map(normRow).filter(r=>Object.keys(r).length);$("#meta").textContent=`已載入：${f.name}（${label}），筆數 ${RAW.length}`;recompute();};
  if(/\.csv$/i.test(f.name)){
    const r1=new FileReader();
    r1.onload=e=>{try{const wb=XLSX.read(e.target.result,{type:"binary",codepage:950});const arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});if(mojibake(Object.keys(arr[0]||{})))throw 0;done(arr,"Big5");}catch{const r2=new FileReader();r2.onload=e2=>{const wb=XLSX.read(e2.target.result,{type:"string",codepage:65001});const arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});done(arr,"UTF-8");};r2.readAsText(f,"utf-8");}};r1.readAsBinaryString(f);
  }else{const r=new FileReader();r.onload=e=>{const wb=XLSX.read(e.target.result,{type:"array"});const arr=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});done(arr,"XLSX");};r.readAsArrayBuffer(f);}
});

function getLimit(){const v=parseInt($("#selLimit").value,10);return isNaN(v)?10:Math.max(1,Math.min(1000,v));}
function compute(){
  if(!RAW.length)return[];
  const want=$("#selType").value,dropZero=$("#chkFilterZeroSpread").checked;
  const rows=RAW.map(r=>{
    const name=r["權證名稱"]??"",code=r["權證代碼"];
    let cp="";if(/[售]/.test(name)||/\bP\b/i.test(name)||/PUT/i.test(name))cp="P";
    else if(/[購]/.test(name)||/\bC\b/i.test(name)||/CALL/i.test(name))cp="C";
    const spread=num(r["買賣價差比"]),lev=num(r["實質槓桿"]),exr=num(r["行使比例"]),days=num(r["距到期天數"]);
    const s1=(spread!=null&&Math.abs(lev)>0)?spread/Math.abs(lev):null;
    const s2=(s1!=null&&exr>0)?s1/exr:null;
    return{code,name,cp,spread,leverage:lev,exercise:exr,s1,s2,days_left:isFinite(days)?Math.round(days):null,strike:r["履約價"],price:r["權證成交價"]??r["成交價"],iv:num(r["成交價隱波"]),moneyness:r["價內外程度"],float_rate:r["流通在外比率"]};
  }).filter(x=>x.cp===want&&(x.days_left==null||x.days_left>60)&&(!dropZero||(+x.spread!==0)));
  const key=$("#selSortKey").value,dir=$("#selOrder").value==="desc"?-1:1;
  rows.sort((a,b)=>{const va=a[key],vb=b[key];if(va==null&&vb==null)return 0;if(va==null)return 1;if(vb==null)return-1;return(va>vb?1:(va<vb?-1:0))*dir;});
  return rows;
}
function rowHTML(r){
  return `<td><b>${r.code??""}</b></td><td>${r.name??""}</td><td><span class="tag">${r.cp??""}</span></td>
    <td>${fmtNum(r.spread,3)}</td><td>${fmtNum(Math.abs(r.leverage),3)}</td><td>${fmtNum(r.exercise,3)}</td>
    <td class="gold-text">${showPct100(r.s1,2)}</td><td class="gold-text">${showPct100(r.s2,2)}</td>
    <td>${r.days_left??"—"}</td><td>${r.strike??""}</td><td>${r.price==null?"":fmtNum(r.price,3)}</td>
    <td>${r.iv==null?"—":fmtNum(r.iv,3)}</td><td>${r.moneyness??""}</td><td>${r.float_rate??""}</td>`;
}
function render(rows){
  $("#resultCard").style.display="block";
  const limit=getLimit(),shown=rows.slice(0,limit);
  $("#meta2").textContent=`筆數：顯示 ${shown.length} / 總 ${rows.length}`;
  const tb=$("#tbody");tb.innerHTML="";
  shown.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=rowHTML(r);tb.appendChild(tr);});
}
function recompute(){render(compute());}
["selType","selSortKey","selOrder","chkFilterZeroSpread","selLimit"].forEach(id=>{$(`#${id}`).addEventListener("change",recompute);$(`#${id}`).addEventListener("input",recompute);});
document.addEventListener("DOMContentLoaded",()=>recompute());

/* 匯出 PNG（目前顯示筆數 + 標題完整） */
$("#btnExportPng").addEventListener("click",async()=>{
  const rows=compute().slice(0,getLimit());
  if(!rows.length)return;
  document.body.classList.add("exporting");

  const clone=$("#resultCard").cloneNode(true);
  clone.id="exportClone";
  const sc=clone.querySelector("#resultScroll");
  if(sc){sc.style.maxHeight="unset";sc.style.overflow="visible";}
  const tb=clone.querySelector("#tbody");
  tb.innerHTML="";
  rows.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=rowHTML(r);tb.appendChild(tr);});

  const wrap=document.createElement("div");
  wrap.style.position="absolute";wrap.style.left="-9999px";wrap.appendChild(clone);
  document.body.appendChild(wrap);

  const canvas=await html2canvas(clone,{backgroundColor:null,scale:2});
  const a=document.createElement("a");
  const dt=new Date();a.download=`warrant_filter_${dt.getFullYear()}${String(dt.getMonth()+1).padStart(2,"0")}${String(dt.getDate()).padStart(2,"0")}.png`;
  a.href=canvas.toDataURL("image/png");a.click();
  wrap.remove();document.body.classList.remove("exporting");
});
</script>
</body>
</html>
